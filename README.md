# DAEC

**D**istributed **A**rithmetic **E**xpression **C**alculator

Aka Распределенный вычислитель арифметических выражений.

> [!IMPORTANT]
> Это не полноценный проект, а всего-лишь решение на финальную задачу в Яндекс Лицее.
> Вся документация и комментарии в коде ведутся на русском языке.

<p align="center">
  <samp>
    Быстрая навигация
    <br>
    <a href="https://github.com/wavy-cat/DAEC/tree/main/examples">Примеры и тесты</a> · 
    <a href="https://github.com/wavy-cat/DAEC/tree/main/docs">API Reference</a>
  </samp>
</p>

## Архитектура проекта

Основные части приложения:

* Backend aka оркестратор
* Agent (демон) aka вычислитель
* Frontend (не имеет отдельного сервера) aka веб-интерфейс

Вычисления происходят в вычислителе, оркестратор лишь распараллеливает задачу и передаёт её частями агенту.
Также оркестратор хранит данные о задачах, выражениях и пользователях.

Оркестратор является многопользовательским.
Для работы с некоторыми эндпойнтами нужно быть зарегистрированным и предоставлять JWT токен.
Подробнее читайте в документации в [разделе "Авторизация"](docs/Authorization.md).

В качестве основного веб-сервера предлагается использовать [Caddy](https://caddyserver.com/).
Он уже присутствует в Docker Compose.

### Терминология

* Выражение — любое мат. выражение, состоящее из неограниченного кол-ва операторов и операндов. Передаётся от клиента
  оркестратору.
* Задача — простое мат. выражение из одного оператора и двух операндов. Является частью Выражения. Передаётся от
  оркестратора агенту.

### Концепции клиента и агента

Общение оркестратора с клиентом:

* Происходит по HTTP (REST API с JSON).
* Идентификаторы имеют тип int64.
* Выражения и пользователи хранятся в SQLite.

Общение оркестратора с агентом:

* Происходит по gRPC (Protobuf).
* Идентификаторы имеют тип UUIDv4.
* Задачи хранятся в in-memory базе данных.

> При перезагрузке оркестратора незавершённые выражения отправляются заново на обработку.

## Что поддерживается

* Целочисленные числа
* Вещественные числа (разделяется через точку)
* Унарный минус (см. "Проблемы" пакета [postfix](backend/pkg/postfix/README.md))
* Операторы `+`, `-`, `*`, `/`, `^`
* Скобки

## Как запустить систему

### Запуск в Docker Compose

Для этого способа у вас должен быть установлен Git, Docker и Docker Compose.
Инструкции по установке Docker доступны на [официальном сайте](https://www.docker.com/get-started/). Можно также использовать Docker Desktop.

```bash
git clone https://github.com/wavy-cat/DAEC.git
cd DAEC
docker compose up -d
```

Для выключения:

```bash
cd DAEC # Если ещё не в папке с проектом
docker compose down
```

После запуска будет доступно API на http://localhost/api/v1/.
А веб-интерфейс на http://localhost.

Если вы хотите изменить адрес сервера, то отредактируйте [Caddyfile](Caddyfile).
А также [config.js](frontend/js/config.js) в веб-интерфейсе.

Время, требуемое для вычисления выражения из задачи, и computing power указываются в файле [.env](.env).

> [!NOTE]
> Иногда после запуска вы можете увидеть код ответа 502 Bad Gateway.
> В этом случае просто подождите, пока оркестратор запустится полностью.

### Запуск напрямую

В документации не будет описан. Используйте запуск через Docker.

Либо, можете попытаться запустить самостоятельно без инструкции.

## Остальная документация и примеры

Примеры находятся в папке [examples](examples).

Документация с API Reference и инструкциями по авторизации находятся в папке [docs](docs).

> [!NOTE]
> Примеры находятся в папке [examples](examples).

API полностью соответствует представленному в задаче (за исключением идентификаторов, они используют uuid).

### Client-side

#### Добавление вычисления арифметического выражения

`POST /api/v1/calculate`

Тело запроса:

```json5
{
  "expression": "строка с выражением"
}
```

Тело ответа:

```json5
{
  "id": "уникальный идентификатор выражения (UUID)"
}
```

Возможные коды ответа:

* 201 - выражение принято для вычисления
* 422 - невалидные данные / ошибка в выражении
* 500 - что-то пошло не так

#### Получение списка выражений

`GET localhost/api/v1/expressions`

Тело ответа:

```json5
{
  "expressions": [
    {
      "id": "идентификатор выражения (UUID)",
      "status": "статус вычисления выражения",
      // допустимые значения: pending, error, done
      "result": 0.0
      // результат выражения (вещественное число)
    },
    {
      "id": "идентификатор выражения (UUID)",
      "status": "статус вычисления выражения",
      // допустимые значения: pending, error, done
      "result": 1.0
      // результат выражения (вещественное число)
    }
  ]
}
```

Возможные коды ответа:

* 200 - успешно получен список выражений
* 500 - что-то пошло не так

#### Получение выражения по его идентификатору

`GET /api/v1/expressions/{id}`

Тело ответа:

```json5
{
  "expression": {
    "id": "идентификатор выражения (UUID)",
    "status": "статус вычисления выражения",
    // допустимые значения: queue, processing, done
    "result": 2.5
    // результат выражения (вещественное число)
  }
}
```

Возможные коды ответа:

* 200 - успешно получено выражение
* 404 - выражение не найдено
* 500 - что-то пошло не так

### Agent-side

#### Получение задачи для выполнения

`GET /internal/task`

Тело ответа:

```json5
{
  "task": {
    "id": "идентификатор задачи (UUID)",
    "arg1": 1.5,
    // первый аргумент (вещественное число)
    "arg2": 3,
    // второй аргумент (вещественное число)
    "operation": "операция",
    // Один символ
    "operation_time": 5000
    // время выполнения операции (целочисленное число)
  }
}
```

Возможные коды ответа:

* 200 - успешно получена задача
* 404 - нет задачи
* 500 - что-то пошло не так

#### Приём результата обработки данных

`POST /internal/task`

Тело запроса:

```json5
{
  "id": "идентификатор задачи (UUID)",
  "result": 10.5
  // результат (вещественное число), либо null
}
```

Возможные коды ответа:

* 200 - успешно записан результат
* 404 - нет такой задачи
* 422 - невалидные данные
* 500 - что-то пошло не так
